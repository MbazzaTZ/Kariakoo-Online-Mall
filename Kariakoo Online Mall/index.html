<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kariakoo Online Mall</title>

    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React Development versions -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for use in the Babel script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection,
            addDoc,
            deleteDoc,
            query,
            where,
            getDocs,
            serverTimestamp // Added serverTimestamp
        };
    </script>

    <style>
        /* Set a dark theme for the scrollbar and body */
        body {
            background-color: #111827; /* gray-900 */
            font-family: 'Inter', sans-serif;
            color: #ffffff; /* Default text color for the shop page */
            min-height: 100vh; /* Ensure body takes full viewport height */
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #1f2937; /* Tailwind gray-800 */
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #4b5563; /* Tailwind gray-600 */
          border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #6b7280; /* Tailwind gray-500 */
        }
    </style>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- React Hooks and State Management ---
        const { useState, useRef, useEffect, createContext, useContext } = React;

        // --- Firebase Context ---
        // Create a context to provide Firebase instances and auth state to components
        const AuthContext = createContext(null);

        // AuthProvider component to manage Firebase initialization and authentication
        const AuthProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState(null); // New state for user email
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isVendor, setIsVendor] = useState(false); // New state for vendor status
            const [userProfile, setUserProfile] = useState(null); // New state for user profile

            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Firebase configuration provided by the user
                        const firebaseConfig = {
                            apiKey: "AIzaSyCfqHwlB8kF069g9Iqyulch4w_6QpkGG4g",
                            authDomain: "sportsphere-online-shop.firebaseapp.com",
                            projectId: "sportsphere-online-shop",
                            storageBucket: "sportsphere-online-shop.firebasestorage.app",
                            messagingSenderId: "959675757179",
                            appId: "1:959675757179:web:76c67d3f26a5fd229a28de",
                            measurementId: "G-K9KBEC69BG"
                        };

                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                        const app = firebase.initializeApp(firebaseConfig);
                        const firestore = firebase.getFirestore(app);
                        const authInstance = firebase.getAuth(app);

                        setDb(firestore);
                        setAuth(authInstance);

                        // Sign in with custom token if available, otherwise anonymously
                        if (initialAuthToken) {
                            await firebase.signInWithCustomToken(authInstance, initialAuthToken);
                        } else {
                            await firebase.signInAnonymously(authInstance);
                        }

                        // Listen for auth state changes
                        const unsubscribe = firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setUserEmail(user.email);

                                // Fetch user profile from Firestore
                                const docRef = firebase.doc(firestore, `artifacts/${appId}/users/${user.uid}`);
                                const docSnap = await firebase.getDoc(docRef);

                                if (docSnap.exists()) {
                                    const profileData = docSnap.data();
                                    setUserProfile(profileData);
                                    // Determine if user is a vendor based on a 'role' field in their profile
                                    setIsVendor(profileData.role === 'vendor');
                                } else {
                                    // Create a new user profile document if it doesn't exist
                                    const newUserProfile = {
                                        email: user.email,
                                        createdAt: firebase.serverTimestamp(),
                                        role: 'customer' // Default role for new users
                                    };
                                    await firebase.setDoc(docRef, newUserProfile);
                                    setUserProfile(newUserProfile);
                                    setIsVendor(newUserProfile.role === 'vendor');
                                }
                            } else {
                                setUserId(null);
                                setUserEmail(null);
                                setUserProfile(null);
                                setIsVendor(false);
                            }
                            setIsAuthReady(true); // Auth state is ready after initial check
                        });

                        return () => unsubscribe(); // Cleanup auth listener
                    } catch (error) {
                        console.error("Error initializing Firebase or signing in:", error);
                        setIsAuthReady(true); // Still set ready even on error to avoid infinite loading
                    }
                };

                initializeFirebase();
            }, []); // Run only once on mount

            const signOutUser = async () => {
                try {
                    await firebase.signOut(auth);
                } catch (error) {
                    console.error("Error signing out: ", error.message);
                }
            };

            return (
                <AuthContext.Provider value={{ db, auth, userId, userEmail, isAuthReady, isVendor, userProfile, signOutUser }}>
                    {children}
                </AuthContext.Provider>
            );
        };


        // --- Data & Configuration ---

        // Product categories for product listing
        const productCategories = [
            { category: 'Jerseys', name: 'Jersey' },
            { category: 'Tickets', name: 'Ticket' },
            { category: 'Accessories', name: 'Accessory' },
            { category: 'Equipment', name: 'Equipment' },
            { category: 'Club membership', name: 'Club Membership' },
            { category: 'Clothes', name: 'Clothing' }, // New category
            { category: 'Shoes', name: 'Footwear' },   // New category
            { category: 'Fashion', name: 'Fashion Item' }, // New category
            { category: 'Health and Beauty', name: 'Health & Beauty Product' } // New category
        ];

        // All possible locations for filtering and shipping
        const allLocations = ['Dar es Salaam', 'Arusha', 'Mwanza', 'Nairobi', 'Mombasa', 'Kampala', 'Kigali', 'Bujumbura', 'Addis Ababa', 'Zanzibar'];


        // Helper function to get more realistic Unsplash image URLs (still useful for new product adds)
        const getUnsplashImageUrl = (category, name) => {
            let keywords = '';
            switch (category) {
                case 'Jerseys':
                    keywords = 'football,soccer,basketball,jersey,sportswear';
                    break;
                case 'Tickets':
                    keywords = 'stadium,sports,tickets,event';
                    break;
                case 'Accessories':
                    keywords = 'sports,accessories,gym,fitness';
                    break;
                case 'Equipment':
                    keywords = 'sports,equipment,ball,weights,gear';
                    break;
                case 'Club membership':
                    keywords = 'sports,community,fans,membership';
                    break;
                case 'Clothes':
                    keywords = 'clothing,apparel,fashion,t-shirt,jacket';
                    break;
                case 'Shoes':
                    keywords = 'shoes,sneakers,footwear,boots';
                    break;
                case 'Fashion':
                    keywords = 'fashion,style,jewelry,handbag,accessories';
                    break;
                case 'Health and Beauty':
                    keywords = 'health,beauty,cosmetics,skincare,wellness';
                    break;
                default:
                    keywords = 'product,merchandise,shop'; // More general fallback
            }
            const nameWords = name.split(' ').filter(word => word.length > 3 && !['home', 'away', 'jersey', 'ticket', 'scarf', 'ball'].includes(word.toLowerCase()));
            if (nameWords.length > 0) {
                keywords += ',' + nameWords.join(',');
            }
            return `https://source.unsplash.com/random/400x400/?${keywords}&sig=${Math.random().toString(36).substr(2, 9)}`;
        };

        // --- Shipping Calculation Logic (Simplified) ---
        const calculateShippingCost = (vendorLocation, customerLocation, itemPrice) => {
            const localShippingCost = 5000; // TZS for same city/nearby
            const regionalShippingCost = 15000; // TZS for East Africa
            const internationalShippingCost = 30000; // TZS for outside East Africa (mock)

            const eastAfricanCountries = ['Dar es Salaam', 'Arusha', 'Mwanza', 'Nairobi', 'Mombasa', 'Kampala', 'Kigali', 'Bujumbura', 'Addis Ababa', 'Zanzibar'];

            const isVendorEA = eastAfricanCountries.includes(vendorLocation);
            const isCustomerEA = eastAfricanCountries.includes(customerLocation);

            if (vendorLocation === customerLocation) {
                return localShippingCost;
            } else if (isVendorEA && isCustomerEA) {
                return regionalShippingCost;
            } else {
                return internationalShippingCost;
            }
        };

        // --- UI Components ---

        /**
         * Displays a single product card for the shop.
         * @param {object} props - Component props.
         * @param {object} props.product - The product data.
         * @param {function} props.onAddToCart - Callback to add product to cart.
         * @param {function} props.onAddToWatchlist - Callback to add product to watchlist.
         */
        const ProductCard = ({ product, onAddToCart, onAddToWatchlist }) => (
          <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 flex flex-col">
            <div className="relative w-full h-56 bg-gray-700">
              {product.sale && (
                <span className="absolute top-3 left-3 px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-md z-10">SALE</span>
              )}
              <img src={product.imageUrl} alt={product.name} className="w-full h-full object-cover" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x400/1f2937/4b5563?text=Image+Not+Found'; }} />
            </div>
            <div className="p-4 flex flex-col flex-grow">
              <div className="flex justify-between items-center mb-2">
                <span className="px-2 py-1 bg-gray-700 text-gray-300 text-xs font-semibold rounded-md">{product.category}</span>
                <div className="flex items-center text-sm text-gray-400" aria-label={`${product.rating} out of 5 stars, based on ${product.reviews} reviews`}>
                  <svg className="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z"></path></svg>
                  <span>{product.rating} ({product.reviews})</span>
                </div>
              </div>
              <h3 className="text-lg font-bold text-white mb-1">{product.name}</h3>
              <p className="text-gray-400 text-sm mb-2 flex-grow">{product.description}</p>
              {/* Display vendor information and location */}
              <p className="text-gray-500 text-xs mb-4">Sold by: <span className="font-semibold text-gray-400">{product.vendor}</span> from <span className="font-semibold text-gray-400">{product.location}</span></p>

              <div className="flex items-baseline space-x-2 mb-4">
                <span className="text-2xl font-bold text-cyan-500">TZS {product.price.toLocaleString()}</span> {/* Display price in TZS */}
                {product.oldPrice && <span className="text-gray-500 line-through">TZS {product.oldPrice.toLocaleString()}</span>}
              </div>
              <div className="flex space-x-3">
                <button
                    onClick={() => onAddToCart(product)}
                    className="flex items-center justify-center flex-1 py-3 bg-cyan-500 rounded-lg font-semibold text-white hover:bg-cyan-600 transition-colors duration-200"
                    aria-label={`Add ${product.name} to cart`}
                >
                  <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.5 14 6.354 14H17a1 1 0 000-2h-1.539l-.821-2.82a1 1 0 00-.01-.042l-1.358-5.43L8.12 3H3zM10 18a1 1 0 100-2 1 1 0 000 2zm-2 0a1 1 0 100-2 1 1 0 000 2zm5-5a1 1 0 100-2 1 1 0 000 2zm2 0a1 1 0 100-2 1 1 0 000 2z"></path></svg>
                  Add to Cart
                </button>
                <button
                    onClick={() => onAddToWatchlist(product)}
                    className="px-5 py-3 bg-gray-700 rounded-lg font-semibold text-gray-300 hover:bg-gray-600 transition-colors duration-200"
                    aria-label={`Add ${product.name} to watchlist`}
                >
                  Watch
                </button>
              </div>
            </div>
          </div>
        );

        /**
         * Displays a list of vendors.
         * @param {object} props - Component props.
         * @param {Array<string>} props.vendors - List of vendor names.
         * @param {string} props.selectedVendor - Currently selected vendor for filtering.
         * @param {function} props.onSelectVendor - Callback to select a vendor.
         */
        const VendorList = ({ vendors, selectedVendor, onSelectVendor }) => (
            <div className="bg-gray-800 rounded-xl p-4 border border-gray-700 mt-6">
                <h3 className="text-lg font-bold mb-4 text-white">Vendors</h3>
                <div className="space-y-2">
                    <button
                        onClick={() => onSelectVendor('All')}
                        className={`w-full text-left p-3 rounded-lg transition-colors duration-200 ${selectedVendor === 'All' ? 'bg-cyan-500 text-white font-semibold' : 'text-gray-300 hover:bg-gray-700'}`}
                    >
                        All Vendors
                    </button>
                    {vendors.map(vendor => (
                        <button
                            key={vendor}
                            onClick={() => onSelectVendor(vendor)}
                            className={`w-full text-left p-3 rounded-lg transition-colors duration-200 ${selectedVendor === vendor ? 'bg-cyan-500 text-white font-semibold' : 'text-gray-300 hover:bg-gray-700'}`}
                        >
                            {vendor}
                        </button>
                    ))}
                </div>
            </div>
        );

        /**
         * Modal for Vendor Registration and Product Listing.
         * @param {object} props - Component props.
         * @param {boolean} props.isOpen - Whether the modal is open.
         * @param {function} props.onClose - Callback to close the modal.
         * @param {function} props.onRegisterAndList - Callback to handle vendor registration and product listing.
         */
        const VendorRegistrationModal = ({ isOpen, onClose, onRegisterAndList }) => {
            const [vendorName, setVendorName] = useState('');
            const [vendorEmail, setVendorEmail] = useState('');
            const [vendorDescription, setVendorDescription] = useState('');
            const [productName, setProductName] = useState('');
            const [productCategory, setProductCategory] = useState(productCategories[0].category); // Default to first category
            const [productPrice, setProductPrice] = useState('');
            const [productDescription, setProductDescription] = useState('');

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                // Basic validation
                if (!vendorName || !vendorEmail || !productName || !productPrice) {
                    // Using console.error instead of alert for better UX
                    console.error('Please fill in all required fields.');
                    return;
                }

                const newProduct = {
                    name: productName,
                    category: productCategory,
                    rating: (Math.random() * 1.5 + 3.5).toFixed(1), // Mock rating for new product
                    reviews: 0, // New products start with 0 reviews
                    price: parseFloat(productPrice),
                    oldPrice: null,
                    sale: false,
                    imageUrl: getUnsplashImageUrl(productCategory, productName),
                    description: productDescription || `A great product from ${vendorName}.`,
                    sportCompetition: "General Sports", // Default for new products
                    location: "Online", // Default for new products
                    vendor: vendorName,
                    timestamp: firebase.serverTimestamp() // Add server timestamp
                };

                onRegisterAndList(newProduct);

                // Reset form
                setVendorName('');
                setVendorEmail('');
                setVendorDescription('');
                setProductName('');
                setProductCategory(productCategories[0].category);
                setProductPrice('');
                setProductDescription('');
                onClose(); // Close modal after submission
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]" role="dialog" aria-modal="true" aria-labelledby="vendor-modal-title">
                    <div className="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-2xl border border-gray-700 relative custom-scrollbar overflow-y-auto max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl p-2 rounded-full" aria-label="Close vendor registration modal">&times;</button>
                        <h2 id="vendor-modal-title" className="text-2xl font-bold text-white mb-6">Become a Vendor & List Product</h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Vendor Details */}
                            <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                <h3 className="text-xl font-semibold mb-4 text-white">Your Business Details</h3>
                                <div>
                                    <label htmlFor="vendor-name" className="block text-gray-300 text-sm font-medium mb-2">Business Name <span className="text-red-500">*</span></label>
                                    <input
                                        type="text"
                                        id="vendor-name"
                                        value={vendorName}
                                        onChange={(e) => setVendorName(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        required
                                    />
                                </div>
                                <div className="mt-4">
                                    <label htmlFor="vendor-email" className="block text-gray-300 text-sm font-medium mb-2">Contact Email <span className="text-red-500">*</span></label>
                                    <input
                                        type="email"
                                        id="vendor-email"
                                        value={vendorEmail}
                                        onChange={(e) => setVendorEmail(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        required
                                    />
                                </div>
                                <div className="mt-4">
                                    <label htmlFor="vendor-description" className="block text-gray-300 text-sm font-medium mb-2">Business Description</label>
                                    <textarea
                                        id="vendor-description"
                                        value={vendorDescription}
                                        onChange={(e) => setVendorDescription(e.target.value)}
                                        rows="3"
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    ></textarea>
                                </div>
                            </div>

                            {/* Product Details */}
                            <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                <h3 className="text-xl font-semibold mb-4 text-white">Product to List</h3>
                                <div>
                                    <label htmlFor="product-name" className="block text-gray-300 text-sm font-medium mb-2">Product Name <span className="text-red-500">*</span></label>
                                    <input
                                        type="text"
                                        id="product-name"
                                        value={productName}
                                        onChange={(e) => setProductName(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        required
                                    />
                                </div>
                                <div className="mt-4">
                                    <label htmlFor="product-category" className="block text-gray-300 text-sm font-medium mb-2">Category <span className="text-red-500">*</span></label>
                                    <select
                                        id="product-category"
                                        value={productCategory}
                                        onChange={(e) => setProductCategory(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        required
                                    >
                                        {productCategories.map(type => (
                                            <option key={type.category} value={type.category}>{type.category}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="mt-4">
                                    <label htmlFor="product-price" className="block text-gray-300 text-sm font-medium mb-2">Price (TZS) <span className="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        id="product-price"
                                        value={productPrice}
                                        onChange={(e) => setProductPrice(e.target.value)}
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        min="0"
                                        step="100"
                                        required
                                    />
                                </div>
                                <div className="mt-4">
                                    <label htmlFor="product-description" className="block text-gray-300 text-sm font-medium mb-2">Product Description</label>
                                    <textarea
                                        id="product-description"
                                        value={productDescription}
                                        onChange={(e) => setProductDescription(e.target.value)}
                                        rows="3"
                                        className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    ></textarea>
                                </div>
                            </div>

                            <button
                                type="submit"
                                className="w-full py-3 bg-cyan-500 rounded-lg font-semibold text-white hover:bg-cyan-600 transition-colors duration-200 shadow-md"
                                aria-label="Register and List Product"
                            >
                                Register & List Product
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        /**
         * Modal for user preferences.
         * @param {object} props - Component props.
         * @param {boolean} props.isOpen - Whether the modal is open.
         * @param {function} props.onClose - Callback to close the modal.
         * @param {object} props.preferences - Current preferences.
         * @param {function} props.onSavePreferences - Callback to save preferences.
         * @param {function} props.onLoadPreferences - Callback to load preferences.
         * @param {string} props.userId - The current user's ID.
         * @param {string} props.userEmail - The current user's email.
         * @param {string} props.customerLocation - The current customer's location.
         * @param {function} props.setCustomerLocation - Function to update customer location.
         * @param {Array<string>} props.allLocations - List of all available locations.
         * @param {string} props.userRole - The current user's role.
         * @param {function} props.setUserRole - Function to update the user's role.
         * @param {object} props.auth - Firebase Auth instance.
         */
        const UserPreferencesModal = ({ isOpen, onClose, preferences, onSavePreferences, onLoadPreferences, userId, userEmail, customerLocation, setCustomerLocation, allLocations, userRole, setUserRole, auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');

            // Clear messages on modal open/close - This useEffect must be at the top level
            useEffect(() => {
                if (isOpen) {
                    setError('');
                    setMessage('');
                }
            }, [isOpen]);

            if (!isOpen) return null; // Conditional render after hooks

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                if (password !== confirmPassword) {
                    setError("Passwords do not match.");
                    return;
                }
                try {
                    await firebase.createUserWithEmailAndPassword(auth, email, password);
                    setMessage("Registration successful! You are now logged in.");
                    setEmail('');
                    setPassword('');
                    setConfirmPassword('');
                } catch (err) {
                    console.error("Registration error:", err);
                    setError(err.message);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                try {
                    await firebase.signInWithEmailAndPassword(auth, email, password);
                    setMessage("Login successful!");
                    setEmail('');
                    setPassword('');
                } catch (err) {
                    console.error("Login error:", err);
                    setError(err.message);
                }
            };

            const handleGoogleLogin = async () => {
                setError('');
                setMessage('');
                try {
                    const provider = new firebase.GoogleAuthProvider();
                    await firebase.signInWithPopup(auth, provider);
                    setMessage("Google login successful!");
                } catch (err) {
                    console.error("Google login error:", err);
                    setError(err.message);
                }
            };

            const handleLogout = async () => {
                setError('');
                setMessage('');
                try {
                    await firebase.signOut(auth);
                    setMessage("Logged out successfully!");
                    onClose(); // Close modal after logout
                } catch (err) {
                    console.error("Logout error:", err);
                    setError(err.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]" role="dialog" aria-modal="true" aria-labelledby="preferences-modal-title">
                    <div className="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-md border border-gray-700 relative custom-scrollbar overflow-y-auto max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl p-2 rounded-full" aria-label="Close preferences modal">&times;</button>
                        <h2 id="preferences-modal-title" className="text-2xl font-bold text-white mb-6">My Account & Preferences</h2>

                        {error && <div className="bg-red-800 text-white p-3 rounded-lg mb-4 text-sm">{error}</div>}
                        {message && <div className="bg-green-800 text-white p-3 rounded-lg mb-4 text-sm">{message}</div>}

                        {userId ? ( // User is logged in
                            <div className="space-y-4">
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-3 text-white">My Profile</h3>
                                    <p className="text-gray-300 text-sm mb-2"><strong>User ID:</strong> <span className="break-all text-cyan-400">{userId}</span></p>
                                    <p className="text-gray-300 text-sm"><strong>Email:</strong> <span className="break-all text-cyan-400">{userEmail || 'N/A'}</span></p>
                                    <button
                                        onClick={handleLogout}
                                        className="w-full py-2 bg-red-600 rounded-lg font-semibold text-white hover:bg-red-700 transition-colors duration-200 mt-4"
                                        aria-label="Log out of your account"
                                    >
                                        Logout
                                    </button>
                                </div>

                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-3 text-white">Shop Preferences</h3>
                                    <p className="text-gray-300 text-sm">
                                        Current Saved Category: <span className="font-semibold text-cyan-400">{preferences.activeCategory || 'None'}</span>
                                    </p>
                                    <p className="text-gray-300 text-sm">
                                        Current Saved Sport Competition: <span className="font-semibold text-cyan-400">{preferences.selectedSportCompetition || 'None'}</span>
                                    </p>
                                    <div className="mt-4">
                                        <label htmlFor="customer-location" className="block text-gray-300 text-sm font-medium mb-2">Your Location</label>
                                        <select
                                            id="customer-location"
                                            value={customerLocation}
                                            onChange={(e) => setCustomerLocation(e.target.value)}
                                            className="w-full p-2 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        >
                                            {allLocations.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                                        </select>
                                    </div>
                                    <div className="mt-4">
                                        <label htmlFor="user-role" className="block text-gray-300 text-sm font-medium mb-2">Your Role (Demo)</label>
                                        <select
                                            id="user-role"
                                            value={userRole}
                                            onChange={(e) => setUserRole(e.target.value)}
                                            className="w-full p-2 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        >
                                            <option value="customer">Customer</option>
                                            <option value="vendor">Vendor</option> {/* Added vendor role option */}
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 mt-4">
                                        <button
                                            onClick={onSavePreferences}
                                            className="flex-1 py-2 bg-blue-600 rounded-lg font-semibold text-white hover:bg-blue-700 transition-colors duration-200"
                                            aria-label="Save current shop preferences"
                                        >
                                            Save Current Filters
                                        </button>
                                        <button
                                            onClick={onLoadPreferences}
                                            className="flex-1 py-2 bg-gray-600 rounded-lg font-semibold text-white hover:bg-gray-700 transition-colors duration-200"
                                            aria-label="Load saved shop preferences"
                                        >
                                            Load Saved Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : ( // User is not logged in
                            <div className="space-y-6">
                                {/* Login Section */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Sign In</h3>
                                    <form onSubmit={handleLogin} className="space-y-4">
                                        <div>
                                            <label htmlFor="login-email" className="block text-gray-300 text-sm font-medium mb-2">Email</label>
                                            <input
                                                type="email"
                                                id="login-email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="login-password" className="block text-gray-300 text-sm font-medium mb-2">Password</label>
                                            <input
                                                type="password"
                                                id="login-password"
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                                required
                                            />
                                        </div>
                                        <button
                                            type="submit"
                                            className="w-full py-3 bg-blue-600 rounded-lg font-semibold text-white hover:bg-blue-700 transition-colors duration-200"
                                            aria-label="Sign in with email and password"
                                        >
                                            Sign In
                                        </button>
                                    </form>
                                    <div className="mt-4 text-center">
                                        <p className="text-gray-400 mb-2">Or sign in with:</p>
                                        <button
                                            onClick={handleGoogleLogin}
                                            className="w-full py-3 bg-red-600 rounded-lg font-semibold text-white hover:bg-red-700 transition-colors duration-200 flex items-center justify-center space-x-2"
                                            aria-label="Sign in with Google"
                                        >
                                            <svg className="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8c-1.1 4.7-5.5 8.1-10.8 8.1-6.7 0-12.2-5.4-12.2-12.2s5.4-12.2 12.2-12.2c3.7 0 6.9 1.6 9.2 3.8l6.4-6.4C39.4 6.7 33.1 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11.1 0 18.2-7.8 18.2-19.1 0-1.3-.2-2.6-.4-3.8z" fill="#FFC107"/><path d="M6.3 24c0-3.3.9-6.4 2.5-9.1l-6.4-6.4C1.9 12.5 0 17.9 0 24c0 6.1 1.9 11.5 5.2 15.6l6.4-6.4c-1.6-2.7-2.5-5.8-2.5-9.2z" fill="#FF3D00"/><path d="M24 44c6.1 0 11.5-1.9 15.6-5.2l-6.4-6.4c-2.7 1.6-5.8 2.5-9.2 2.5-6.7 0-12.2-5.4-12.2-12.2s5.4-12.2 12.2-12.2c3.7 0 6.9 1.6 9.2 3.8l6.4-6.4C33.1 4 24 4 24 4c-11.1 0-20 8.9-20 20s8.9 20 20 20z" fill="#4CAF50"/><path d="M44.5 20H24v8.5h11.8c-1.1 4.7-5.5 8.1-10.8 8.1-6.7 0-12.2-5.4-12.2-12.2s5.4-12.2 12.2-12.2c3.7 0 6.9 1.6 9.2 3.8l6.4-6.4C39.4 6.7 33.1 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11.1 0 18.2-7.8 18.2-19.1 0-1.3-.2-2.6-.4-3.8z" fill="#1976D2"/></svg>
                                            <span>Sign In with Google</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Register Section */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Register</h3>
                                    <form onSubmit={handleRegister} className="space-y-4">
                                        <div>
                                            <label htmlFor="register-email" className="block text-gray-300 text-sm font-medium mb-2">Email</label>
                                            <input
                                                type="email"
                                                id="register-email"
                                                value={email}
                                                onChange={(e) => setEmail(e.target.value)}
                                                className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="register-password" className="block text-gray-300 text-sm font-medium mb-2">Password</label>
                                            <input
                                                type="password"
                                                id="register-password"
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                                required
                                                minLength="6"
                                            />
                                            <p className="text-gray-400 text-xs mt-1">Minimum 6 characters.</p>
                                        </div>
                                        <div>
                                            <label htmlFor="confirm-password" className="block text-gray-300 text-sm font-medium mb-2">Confirm Password</label>
                                            <input
                                                type="password"
                                                id="confirm-password"
                                                value={confirmPassword}
                                                onChange={(e) => setConfirmPassword(e.target.value)}
                                                className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                                required
                                            />
                                        </div>
                                        <button
                                            type="submit"
                                            className="w-full py-3 bg-emerald-600 rounded-lg font-semibold text-white hover:bg-emerald-700 transition-colors duration-200"
                                            aria-label="Register a new account"
                                        >
                                            Register
                                        </button>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * Modal for Checkout process.
         * @param {object} props - Component props.
         * @param {boolean} props.isOpen - Whether the modal is open.
         * @param {function} props.onClose - Callback to close the modal.
         * @param {Array<object>} props.cartItems - List of items in the cart.
         * @param {string} props.customerLocation - The customer's current location.
         */
        const CheckoutModal = ({ isOpen, onClose, cartItems, customerLocation }) => {
            const [selectedPaymentMethod, setSelectedPaymentMethod] = useState('Visa');
            const [includeInsurance, setIncludeInsurance] = useState(false);
            const [checkoutMessage, setCheckoutMessage] = useState('');
            const [showCheckoutMessage, setShowCheckoutMessage] = useState(false);

            if (!isOpen) return null;

            const subtotal = cartItems.reduce((sum, item) => sum + item.price, 0);
            
            // Calculate total shipping for all items in the cart
            const totalShipping = cartItems.reduce((sum, item) => {
                const shippingCost = calculateShippingCost(item.location, customerLocation, item.price);
                return sum + shippingCost;
            }, 0);

            const insuranceCost = includeInsurance ? subtotal * 0.02 : 0; // 2% of subtotal for insurance
            const totalAmount = subtotal + totalShipping + insuranceCost;

            const handleProceedToPayment = () => {
                console.log("Proceeding to payment with:", {
                    cartItems,
                    customerLocation,
                    selectedPaymentMethod,
                    includeInsurance,
                    subtotal,
                    totalShipping,
                    insuranceCost,
                    totalAmount
                });
                setCheckoutMessage(`Payment for TZS ${totalAmount.toLocaleString()} via ${selectedPaymentMethod} successful! Shipping to ${customerLocation}. Insurance: ${includeInsurance ? 'Yes' : 'No'}.`);
                setShowCheckoutMessage(true);
                // Optionally close modal after a short delay or on user action
                // setTimeout(() => onClose(), 3000);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]" role="dialog" aria-modal="true" aria-labelledby="checkout-modal-title">
                    <div className="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-2xl border border-gray-700 relative custom-scrollbar overflow-y-auto max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl p-2 rounded-full" aria-label="Close checkout modal">&times;</button>
                        <h2 id="checkout-modal-title" className="text-2xl font-bold text-white mb-6">Checkout</h2>

                        {showCheckoutMessage && (
                            <div className="bg-green-800 text-white p-3 rounded-lg mb-4 text-sm">
                                {checkoutMessage}
                                <button onClick={() => { setShowCheckoutMessage(false); onClose(); }} className="ml-4 px-2 py-1 bg-green-900 rounded-md hover:bg-green-800">Close</button>
                            </div>
                        )}

                        {cartItems.length === 0 && !showCheckoutMessage ? (
                            <p className="text-gray-400 text-center">Your cart is empty.</p>
                        ) : (
                            !showCheckoutMessage && ( // Only show checkout details if no message is displayed
                            <div className="space-y-6">
                                {/* Cart Summary */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Order Summary</h3>
                                    {cartItems.map(item => (
                                        <div key={item.id} className="flex justify-between items-center py-2 border-b border-gray-600 last:border-b-0">
                                            <span className="text-gray-300">{item.name}</span>
                                            <span className="text-white font-semibold">TZS {item.price.toLocaleString()}</span>
                                        </div>
                                    ))}
                                    <div className="flex justify-between items-center py-2 mt-2">
                                        <span className="text-gray-300">Subtotal:</span>
                                        <span className="text-white font-bold">TZS {subtotal.toLocaleString()}</span>
                                    </div>
                                </div>

                                {/* Shipping Details */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Shipping Details</h3>
                                    <p className="text-gray-300 text-sm mb-2">Shipping to: <span className="font-semibold text-cyan-400">{customerLocation}</span></p>
                                    {cartItems.map(item => (
                                        <div key={`shipping-${item.id}`} className="flex justify-between items-center py-1 text-sm text-gray-400">
                                            <span>{item.name} (from {item.location})</span>
                                            <span>TZS {calculateShippingCost(item.location, customerLocation, item.price).toLocaleString()}</span>
                                        </div>
                                    ))}
                                    <div className="flex justify-between items-center py-2 mt-2 border-t border-gray-600">
                                        <span className="text-gray-300">Total Shipping:</span>
                                        <span className="text-white font-bold">TZS {totalShipping.toLocaleString()}</span>
                                    </div>
                                </div>

                                {/* Insurance Option */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Insurance</h3>
                                    <label className="flex items-center text-gray-300">
                                        <input
                                            type="checkbox"
                                            checked={includeInsurance}
                                            onChange={(e) => setIncludeInsurance(e.target.checked)}
                                            className="form-checkbox h-5 w-5 text-cyan-500 rounded border-gray-600 bg-gray-900 focus:ring-cyan-500"
                                        />
                                        <span className="ml-2">Add Shipping Insurance (2% of subtotal)</span>
                                    </label>
                                    {includeInsurance && (
                                        <p className="text-gray-400 text-sm mt-2">Insurance Cost: <span className="font-semibold">TZS {insuranceCost.toLocaleString()}</span></p>
                                    )}
                                </div>

                                {/* Payment Methods */}
                                <div className="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <h3 className="text-xl font-semibold mb-4 text-white">Payment Method</h3>
                                    <div className="space-y-3">
                                        {['Visa', 'Mastercard', 'M-Pesa', 'Tigo Pesa', 'Airtel Money'].map(method => (
                                            <label key={method} className="flex items-center text-gray-300">
                                                <input
                                                    type="radio"
                                                    name="paymentMethod"
                                                    value={method}
                                                    checked={selectedPaymentMethod === method}
                                                    onChange={(e) => setSelectedPaymentMethod(e.target.value)}
                                                    className="form-radio h-4 w-4 text-cyan-500 border-gray-600 bg-gray-900 focus:ring-cyan-500"
                                                />
                                                <span className="ml-2">{method}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Total and Pay Button */}
                                <div className="flex justify-between items-center bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <span className="text-2xl font-bold text-white">Total:</span>
                                    <span className="text-3xl font-extrabold text-cyan-500">TZS {totalAmount.toLocaleString()}</span>
                                </div>
                                <button
                                    onClick={handleProceedToPayment}
                                    className="w-full py-3 bg-green-600 rounded-lg font-semibold text-white text-xl hover:bg-green-700 transition-colors duration-200 shadow-md"
                                    aria-label="Proceed to Payment"
                                >
                                    Proceed to Payment
                                </button>
                            </div>
                            )
                        )}
                    </div>
                </div>
            );
        };

        /**
         * Generic Placeholder Modal for various sections.
         * This modal is used for features that are not fully implemented as separate pages yet.
         * @param {object} props - Component props.
         * @param {boolean} props.isOpen - Whether the modal is open.
         * @param {function} props.onClose - Callback to close the modal.
         * @param {string} props.title - Title of the modal.
         * @param {string} props.description - Description of the modal's intended functionality.
         */
        const PlaceholderModal = ({ isOpen, onClose, title, description }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]" role="dialog" aria-modal="true" aria-labelledby="placeholder-modal-title">
                    <div className="bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-md border border-gray-700 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl p-2 rounded-full" aria-label={`Close ${title} modal`}>&times;</button>
                        <h2 id="placeholder-modal-title" className="text-2xl font-bold text-white mb-6">{title}</h2>
                        <p className="text-gray-300 mb-4">{description}</p>
                        <p className="text-gray-400 text-sm">
                            A full implementation would involve dedicated data structures, API integrations, and complex UI/UX for this feature.
                        </p>
                    </div>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Daily Deals.
         */
        const DailyDealsPage = () => {
            // In a real production scenario, this would fetch from a Firestore collection 'dailyDeals'
            const [deals, setDeals] = useState([]); // Initialize as empty

            useEffect(() => {
                // For a real app, you'd fetch from Firestore here:
                // const { db } = useContext(AuthContext);
                // useEffect(() => {
                //     if (db) {
                //         const dealsRef = firebase.collection(db, `artifacts/${__app_id}/public/data/dailyDeals`);
                //         const unsubscribe = firebase.onSnapshot(dealsRef, (snapshot) => {
                //             setDeals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                //         });
                //         return () => unsubscribe();
                //     }
                // }, [db]);
            }, []);

            const [claimMessage, setClaimMessage] = useState('');

            const handleClaimDeal = (dealName) => {
                setClaimMessage(`You've claimed the deal: "${dealName}"! Check your email for details.`);
                setTimeout(() => setClaimMessage(''), 3000); // Clear message after 3 seconds
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">Daily Deals</h2>
                    {claimMessage && (
                        <div className="bg-green-800 text-white p-3 rounded-lg mb-4 text-sm text-center">
                            {claimMessage}
                        </div>
                    )}
                    {deals.length === 0 ? (
                        <p className="text-gray-400 text-center text-lg">No daily deals available right now. Check back soon!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {deals.map(deal => (
                                <div key={deal.id} className="bg-gray-700 rounded-lg p-5 border border-gray-600 flex flex-col items-center text-center">
                                    <img src={deal.imageUrl} alt={deal.name} className="w-full h-32 object-cover rounded-md mb-4" />
                                    <h3 className="text-xl font-semibold text-white mb-2">{deal.name}</h3>
                                    <p className="text-gray-300 text-sm mb-4">Expires: {new Date(deal.expires).toLocaleString()}</p>
                                    <button
                                        onClick={() => handleClaimDeal(deal.name)}
                                        className="mt-auto w-full py-2 bg-cyan-500 rounded-lg font-semibold text-white hover:bg-cyan-600 transition-colors duration-200"
                                    >
                                        Claim Deal
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        This section would be powered by a dedicated "dailyDeals" Firestore collection.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Brand Outlet.
         */
        const BrandOutletPage = () => {
            // In a real production scenario, this would fetch from a Firestore collection 'brands'
            const [brands, setBrands] = useState([]); // Initialize as empty

            useEffect(() => {
                // For a real app, you'd fetch from Firestore here:
                // const { db } = useContext(AuthContext);
                // useEffect(() => {
                //     if (db) {
                //         const brandsRef = firebase.collection(db, `artifacts/${__app_id}/public/data/brands`);
                //         const unsubscribe = firebase.onSnapshot(brandsRef, (snapshot) => {
                //             setBrands(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                //         });
                //         return () => unsubscribe();
                //     }
                // }, [db]);
            }, []);

            const [brandMessage, setBrandMessage] = useState('');

            const handleBrandClick = (brandName) => {
                setBrandMessage(`You clicked on ${brandName}! In a real app, this would filter products by this brand.`);
                setTimeout(() => setBrandMessage(''), 3000);
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">Brand Outlet</h2>
                    {brandMessage && (
                        <div className="bg-blue-800 text-white p-3 rounded-lg mb-4 text-sm text-center">
                            {brandMessage}
                        </div>
                    )}
                    {brands.length === 0 ? (
                        <p className="text-gray-400 text-center text-lg">No brands featured in the outlet currently. Check back later!</p>
                    ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
                            {brands.map(brand => (
                                <button
                                    key={brand.id}
                                    onClick={() => handleBrandClick(brand.name)}
                                    className="bg-gray-700 rounded-lg p-4 border border-gray-600 flex flex-col items-center justify-center text-center hover:bg-gray-600 transition-colors duration-200"
                                    aria-label={`View products from ${brand.name}`}
                                >
                                    <img src={brand.logoUrl} alt={`${brand.name} Logo`} className="w-20 h-20 object-contain mb-2 rounded-full" />
                                    <span className="font-semibold text-white text-lg">{brand.name}</span>
                                </button>
                            ))}
                        </div>
                    )}
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        This section would dynamically load brands from a "brands" Firestore collection.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Gift Cards.
         * @param {object} props - Component props.
         * @param {function} props.onAddGiftCardToCart - Callback to add a gift card to the cart.
         */
        const GiftCardsPage = ({ onAddGiftCardToCart }) => {
            const denominations = [50000, 100000, 250000, 500000, 1000000]; // TZS
            const [selectedAmount, setSelectedAmount] = useState(denominations[0]);
            const [giftCardMessage, setGiftCardMessage] = useState('');

            const handlePurchase = () => {
                const giftCardProduct = {
                    id: `giftcard-${Date.now()}`, // Use timestamp for unique ID for now
                    name: `Kariakoo Online Mall Gift Card (TZS ${selectedAmount.toLocaleString()})`,
                    price: selectedAmount,
                    imageUrl: 'https://placehold.co/400x200/6366f1/ffffff?text=Gift+Card',
                    description: `A Kariakoo Online Mall gift card worth TZS ${selectedAmount.toLocaleString()}.`,
                    category: 'Gift Cards',
                    vendor: 'Kariakoo Online Mall',
                    location: 'Online',
                    rating: '5.0',
                    reviews: 0,
                    sale: false,
                };
                onAddGiftCardToCart(giftCardProduct);
                setGiftCardMessage(`TZS ${selectedAmount.toLocaleString()} gift card added to your cart!`);
                setTimeout(() => setGiftCardMessage(''), 3000);
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh] flex flex-col justify-center items-center text-center">
                    <h2 className="text-3xl font-bold text-white mb-4">Gift Cards</h2>
                    <p className="text-gray-300 text-lg mb-6">
                        Give the gift of shopping! Purchase Kariakoo Online Mall gift cards for friends and family.
                    </p>
                    {giftCardMessage && (
                        <div className="bg-green-800 text-white p-3 rounded-lg mb-4 text-sm">
                            {giftCardMessage}
                        </div>
                    )}
                    <div className="bg-gray-700 p-6 rounded-lg border border-gray-600 w-full max-w-sm">
                        <h3 className="text-xl font-semibold text-white mb-4">Select Amount</h3>
                        <div className="grid grid-cols-3 gap-3 mb-6">
                            {denominations.map(amount => (
                                <button
                                    key={amount}
                                    onClick={() => setSelectedAmount(amount)}
                                    className={`py-3 px-4 rounded-lg font-semibold transition-colors duration-200 ${selectedAmount === amount ? 'bg-cyan-500 text-white' : 'bg-gray-900 text-gray-300 hover:bg-gray-600'}`}
                                >
                                    TZS {amount.toLocaleString()}
                                </button>
                            ))}
                        </div>
                        <button
                            onClick={handlePurchase}
                            className="w-full py-3 bg-green-600 rounded-lg font-semibold text-white hover:bg-green-700 transition-colors duration-200"
                            aria-label={`Add TZS ${selectedAmount.toLocaleString()} gift card to cart`}
                        >
                            Add to Cart (TZS {selectedAmount.toLocaleString()})
                        </button>
                    </div>
                    <p className="text-gray-400 text-sm mt-8">
                        Imagine options for e-gift cards, physical cards, and checking gift card balances.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Help & Contact.
         */
        const HelpContactPage = () => {
            const faqs = [
                {
                    q: "How do I track my order?",
                    a: "You can track your order by logging into 'My Account' and navigating to 'Order History'. Each order will have a tracking link if available."
                },
                {
                    q: "What is your return policy?",
                    a: "We offer a 30-day return policy on most items, provided they are in their original condition. Please see our full returns policy page for details."
                },
                {
                    q: "How can I change my shipping address?",
                    a: "Shipping addresses can be updated in your 'My Account' section under 'Addresses'. For active orders, please contact support immediately."
                },
            ];

            const [activeIndex, setActiveIndex] = useState(null);
            const [contactForm, setContactForm] = useState({ name: '', email: '', subject: '', message: '' });
            const [contactMessage, setContactMessage] = useState('');

            const handleToggleFaq = (index) => {
                setActiveIndex(activeIndex === index ? null : index);
            };

            const handleContactChange = (e) => {
                const { name, value } = e.target;
                setContactForm(prev => ({ ...prev, [name]: value }));
            };

            const handleContactSubmit = (e) => {
                e.preventDefault();
                console.log("Contact form submitted:", contactForm);
                setContactMessage('Your message has been sent! We will get back to you shortly.');
                setContactForm({ name: '', email: '', subject: '', message: '' });
                setTimeout(() => setContactMessage(''), 3000);
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">Help & Contact</h2>

                    <div className="mb-8">
                        <h3 className="text-2xl font-semibold text-white mb-4">Frequently Asked Questions</h3>
                        <div className="space-y-4">
                            {faqs.map((faq, index) => (
                                <div key={index} className="bg-gray-700 rounded-lg border border-gray-600">
                                    <button
                                        className="w-full text-left p-4 flex justify-between items-center text-white font-semibold"
                                        onClick={() => handleToggleFaq(index)}
                                        aria-expanded={activeIndex === index}
                                        aria-controls={`faq-answer-${index}`}
                                    >
                                        <span>{faq.q}</span>
                                        <span>{activeIndex === index ? '-' : '+'}</span>
                                    </button>
                                    {activeIndex === index && (
                                        <div id={`faq-answer-${index}`} className="p-4 pt-0 text-gray-300 text-sm">
                                            {faq.a}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div>
                        <h3 className="text-2xl font-semibold text-white mb-4">Contact Us</h3>
                        {contactMessage && (
                            <div className="bg-green-800 text-white p-3 rounded-lg mb-4 text-sm">
                                {contactMessage}
                            </div>
                        )}
                        <form onSubmit={handleContactSubmit} className="bg-gray-700 p-6 rounded-lg border border-gray-600 space-y-4">
                            <div>
                                <label htmlFor="contact-name" className="block text-gray-300 text-sm font-medium mb-2">Your Name</label>
                                <input type="text" id="contact-name" name="name" value={contactForm.name} onChange={handleContactChange} className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                            </div>
                            <div>
                                <label htmlFor="contact-email" className="block text-gray-300 text-sm font-medium mb-2">Your Email</label>
                                <input type="email" id="contact-email" name="email" value={contactForm.email} onChange={handleContactChange} className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                            </div>
                            <div>
                                <label htmlFor="contact-subject" className="block text-gray-300 text-sm font-medium mb-2">Subject</label>
                                <input type="text" id="contact-subject" name="subject" value={contactForm.subject} onChange={handleContactChange} className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                            </div>
                            <div>
                                <label htmlFor="contact-message" className="block text-gray-300 text-sm font-medium mb-2">Message</label>
                                <textarea id="contact-message" name="message" value={contactForm.message} onChange={handleContactChange} rows="5" className="w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required></textarea>
                            </div>
                            <button type="submit" className="w-full py-3 bg-blue-600 rounded-lg font-semibold text-white hover:bg-blue-700 transition-colors duration-200">
                                Send Message
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Watchlist.
         * @param {object} props - Component props.
         * @param {Array<object>} props.watchlistItems - List of items in the watchlist.
         * @param {function} props.onRemoveFromWatchlist - Callback to remove item from watchlist.
         */
        const WatchlistPage = ({ watchlistItems, onRemoveFromWatchlist }) => {
            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">My Watchlist</h2>
                    {watchlistItems.length === 0 ? (
                        <p className="text-gray-400 text-center text-lg">Your watchlist is empty. Add items from the shop!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {watchlistItems.map(item => (
                                <div key={item.id} className="bg-gray-700 rounded-lg p-4 border border-gray-600 flex flex-col">
                                    <img src={item.imageUrl} alt={item.name} className="w-full h-40 object-cover rounded-md mb-4" />
                                    <h3 className="text-xl font-semibold text-white mb-2">{item.name}</h3>
                                    <p className="text-gray-300 text-sm mb-3">{item.description}</p>
                                    <div className="flex justify-between items-center mt-auto pt-2 border-t border-gray-600">
                                        <span className="text-lg font-bold text-cyan-400">TZS {item.price.toLocaleString()}</span>
                                        <button
                                            onClick={() => onRemoveFromWatchlist(item.id)}
                                            className="px-4 py-2 bg-red-600 rounded-lg font-semibold text-white hover:bg-red-700 transition-colors duration-200 text-sm"
                                        >
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        In a full application, you'd receive notifications for price drops or stock changes on these items.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Notifications.
         */
        const NotificationsPage = () => {
            // In a real production scenario, this would fetch from a Firestore collection 'notifications'
            const [notifications, setNotifications] = useState([]); // Initialize as empty

            useEffect(() => {
                // For a real app, you'd fetch from Firestore here:
                // const { db, userId } = useContext(AuthContext);
                // useEffect(() => {
                //     if (db && userId) {
                //         const notificationsRef = firebase.collection(db, `artifacts/${__app_id}/users/${userId}/notifications`);
                //         const unsubscribe = firebase.onSnapshot(notificationsRef, (snapshot) => {
                //             setNotifications(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                //         });
                //         return () => unsubscribe();
                //     }
                // }, [db, userId]);
            }, []);

            const markAsRead = (id) => {
                setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
            };

            const unreadCount = notifications.filter(n => !n.read).length;

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">Notifications ({unreadCount > 0 ? `${unreadCount} unread` : 'All read'})</h2>
                    {notifications.length === 0 ? (
                        <p className="text-gray-400 text-center text-lg">No notifications yet.</p>
                    ) : (
                        <div className="space-y-4">
                            {notifications.map(notification => (
                                <div key={notification.id} className={`bg-gray-700 rounded-lg p-4 border border-gray-600 flex items-center justify-between ${notification.read ? 'opacity-70' : 'font-semibold'}`}>
                                    <p className={`text-gray-300 ${notification.read ? 'text-gray-400' : 'text-white'}`}>
                                        {notification.message}
                                    </p>
                                    {!notification.read && (
                                        <button
                                            onClick={() => markAsRead(notification.id)}
                                            className="ml-4 px-3 py-1 bg-blue-600 rounded-md text-white text-sm hover:bg-blue-700 transition-colors duration-200"
                                        >
                                            Mark as Read
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        Notifications would be personalized and delivered in real-time from a "notifications" Firestore collection.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Live Updates & Trends.
         */
        const LiveUpdatesSection = () => {
            // In a real production scenario, this would fetch from a Firestore collection 'liveUpdates'
            const [liveScores, setLiveScores] = useState([]); // Initialize as empty
            const [trendingTopics, setTrendingTopics] = useState([]); // Initialize as empty

            useEffect(() => {
                // For a real app, you'd fetch from Firestore here:
                // const { db } = useContext(AuthContext);
                // useEffect(() => {
                //     if (db) {
                //         const liveUpdatesRef = firebase.collection(db, `artifacts/${__app_id}/public/data/liveUpdates`);
                //         const unsubscribe = firebase.onSnapshot(liveUpdatesRef, (snapshot) => {
                //             setLiveScores(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                //         });
                //         return () => unsubscribe();
                //     }
                // }, [db]);
            }, []);

            const refreshData = () => {
                // In a real app, this would trigger a fetch from a real-time API or Firestore
                console.log("Refreshing live data...");
                // Replaced alert with console log as per instructions
                // alert("Data refresh initiated (simulated).");
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">Live Updates & Trends</h2>

                    <div className="flex justify-center mb-6">
                        <button
                            onClick={refreshData}
                            className="px-6 py-3 bg-blue-600 rounded-lg font-semibold text-white hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2"
                            aria-label="Refresh live data"
                        >
                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.569.5.5 0 01-.132.555l-2.181 2.181a1 1 0 001.414 1.414l3.293-3.293a1 1 0 000-1.414l-3.293-3.293a1 1 0 00-1.414 1.414l2.181 2.181a5.002 5.002 0 00-8.775-1.554L5 3a1 1 0 011-1H4zm10 14a1 1 0 00-1-1v-2.101a7.002 7.002 0 01-11.601-2.569.5.5 0 01.132-.555l2.181-2.181a1 1 0 10-1.414-1.414L3.293 11.293a1 1 0 000 1.414l3.293 3.293a1 1 0 001.414-1.414l-2.181-2.181A5.002 5.002 0 0015 17a1 1 0 00-1-1h-4z" clipRule="evenodd"></path></svg>
                            <span>Refresh Data</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Live Scores */}
                        <div className="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h3 className="text-xl font-semibold text-white mb-4">Live Scores</h3>
                            {liveScores.length === 0 ? (
                                <p className="text-gray-400 text-sm">No live scores available.</p>
                            ) : (
                                <div className="space-y-3">
                                    {liveScores.map(score => (
                                        <div key={score.id} className="flex justify-between items-center bg-gray-900 p-3 rounded-md">
                                            <div>
                                                <p className="text-lg font-medium text-white">{score.match}</p>
                                                <p className="text-gray-400 text-sm">{score.status} - {score.time}</p>
                                            </div>
                                            <span className="text-cyan-400 text-2xl font-bold">{score.score}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Trending Topics */}
                        <div className="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h3 className="text-xl font-semibold text-white mb-4">Trending Topics</h3>
                            {trendingTopics.length === 0 ? (
                                <p className="text-gray-400 text-sm">No trending topics right now.</p>
                            ) : (
                                <div className="space-y-3">
                                    {trendingTopics.map(topic => (
                                        <div key={topic.id} className="bg-gray-900 p-3 rounded-md">
                                            <p className="text-lg font-medium text-white">{topic.topic}</p>
                                            <p className="text-gray-400 text-sm">{topic.mentions} mentions</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        This section would integrate with real-time news and trends data APIs for dynamic updates.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for News & Rumors.
         */
        const NewsSection = () => {
            // In a real production scenario, this would fetch from a Firestore collection 'news'
            const [newsArticles, setNewsArticles] = useState([]); // Initialize as empty

            useEffect(() => {
                // For a real app, you'd fetch from Firestore here:
                // const { db } = useContext(AuthContext);
                // useEffect(() => {
                //     if (db) {
                //         const newsRef = firebase.collection(db, `artifacts/${__app_id}/public/data/news`);
                //         const unsubscribe = firebase.onSnapshot(newsRef, (snapshot) => {
                //             setNewsArticles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                //         });
                //         return () => unsubscribe();
                //     }
                // }, [db]);
            }, []);

            const [expandedArticleId, setExpandedArticleId] = useState(null);

            const toggleExpand = (id) => {
                setExpandedArticleId(expandedArticleId === id ? null : id);
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-6 text-center">News & Updates</h2>
                    {newsArticles.length === 0 ? (
                        <p className="text-gray-400 text-center text-lg">No news articles available right now.</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {newsArticles.map(article => (
                                <div key={article.id} className="bg-gray-700 rounded-lg p-5 border border-gray-600 flex flex-col">
                                    <img src={article.imageUrl} alt={article.title} className="w-full h-40 object-cover rounded-md mb-4" />
                                    <h3 className="text-xl font-semibold text-white mb-3">{article.title}</h3>
                                    <p className="text-gray-300 text-sm mb-4 flex-grow">
                                        {expandedArticleId === article.id ? article.fullContent : article.snippet}
                                    </p>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="text-gray-400 text-xs">Published: {article.date}</span>
                                        <button
                                            onClick={() => toggleExpand(article.id)}
                                            className="px-4 py-2 bg-gray-600 rounded-lg font-semibold text-white text-sm hover:bg-gray-500 transition-colors duration-200"
                                        >
                                            {expandedArticleId === article.id ? 'Show Less' : 'Read More'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <p className="text-gray-400 text-sm mt-8 text-center">
                        This section would pull real-time news from various APIs and provide detailed articles.
                    </p>
                </div>
            );
        };

        /**
         * Enhanced Page Component for Admin Dashboard.
         */
        const AdminDashboardPage = () => {
            const [adminMessage, setAdminMessage] = useState('');

            const handleAdminAction = (action) => {
                setAdminMessage(`Admin action simulated: "${action}"`);
                setTimeout(() => setAdminMessage(''), 3000);
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-lg border border-gray-700 min-h-[60vh]">
                    <h2 className="text-3xl font-bold text-white mb-4 text-center">Admin Dashboard</h2>
                    <p className="text-gray-300 text-lg mb-6 text-center">
                        Welcome, Administrator! Here's a quick overview of your Kariakoo Online Mall.
                    </p>
                    {adminMessage && (
                        <div className="bg-blue-800 text-white p-3 rounded-lg mb-4 text-sm text-center">
                            {adminMessage}
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div className="bg-gray-700 rounded-lg p-5 border border-gray-600 text-center">
                            <h3 className="text-xl font-semibold text-white mb-2">Total Users</h3>
                            <p className="text-cyan-400 text-4xl font-bold">N/A</p> {/* Will be fetched from Firestore */}
                            <button onClick={() => handleAdminAction('Manage Users')} className="mt-4 px-4 py-2 bg-gray-600 rounded-lg text-white text-sm hover:bg-gray-500">Manage Users</button>
                        </div>
                        <div className="bg-gray-700 rounded-lg p-5 border border-gray-600 text-center">
                            <h3 className="text-xl font-semibold text-white mb-2">Pending Orders</h3>
                            <p className="text-yellow-400 text-4xl font-bold">N/A</p> {/* Will be fetched from Firestore */}
                            <button onClick={() => handleAdminAction('View Pending Orders')} className="mt-4 px-4 py-2 bg-gray-600 rounded-lg text-white text-sm hover:bg-gray-500">View Orders</button>
                        </div>
                        <div className="bg-gray-700 rounded-lg p-5 border border-gray-600 text-center">
                            <h3 className="text-xl font-semibold text-white mb-2">Products to Approve</h3>
                            <p className="text-red-400 text-4xl font-bold">N/A</p> {/* Will be fetched from Firestore */}
                            <button onClick={() => handleAdminAction('Approve Products')} className="mt-4 px-4 py-2 bg-gray-600 rounded-lg text-white text-sm hover:bg-gray-500">Approve Products</button>
                        </div>
                    </div>

                    <div className="bg-gray-700 rounded-lg p-6 border border-gray-600">
                        <h3 className="text-2xl font-semibold text-white mb-4">Quick Actions</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button onClick={() => handleAdminAction('Add New Product')} className="py-3 bg-emerald-600 rounded-lg font-semibold text-white hover:bg-emerald-700 transition-colors duration-200">Add New Product</button>
                            <button onClick={() => handleAdminAction('Generate Sales Report')} className="py-3 bg-purple-600 rounded-lg font-semibold text-white hover:bg-purple-700 transition-colors duration-200">Generate Sales Report</button>
                            <button onClick={() => handleAdminAction('Update Site Settings')} className="py-3 bg-orange-600 rounded-lg font-semibold text-white hover:bg-orange-700 transition-colors duration-200">Update Site Settings</button>
                        </div>
                    </div>

                    <p className="text-gray-400 text-sm mt-8 text-center">
                        This dashboard would provide comprehensive tools for full site management.
                    </p>
                </div>
            );
        };

        // =========================================================================
        // NEW: Vendor Profile Component
        // =========================================================================
        const VendorProfile = ({ userProfile, onLogout }) => {
            // State to manage which tab is active
            const [activeTab, setActiveTab] = useState('profile');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // A simple component to display vendor's products or uploads
            const VendorProducts = () => {
                // In a real application, you would fetch the vendor's products here
                // For now, using mock data
                const products = [
                    { id: 1, name: "Vendor Product 1", price: 10000, imageUrl: "https://placehold.co/150x150/4b5563/ffffff?text=Product+1", description: "High-quality item." },
                    { id: 2, name: "Vendor Product 2", price: 25000, imageUrl: "https://placehold.co/150x150/4b5563/ffffff?text=Product+2", description: "Durable and stylish." },
                    { id: 3, name: "Vendor Product 3", price: 15000, imageUrl: "https://placehold.co/150x150/4b5563/ffffff?text=Product+3", description: "Great value." },
                ];

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {products.map(product => (
                            <div key={product.id} className="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                                <img src={product.imageUrl} alt={product.name} className="w-full h-32 object-cover mb-4 rounded-lg" />
                                <h3 className="text-lg font-semibold text-white">{product.name}</h3>
                                <p className="text-gray-400 text-sm">{product.description}</p>
                                <p className="text-cyan-400 font-bold mt-2">TZS {product.price.toLocaleString()}</p>
                            </div>
                        ))}
                    </div>
                );
            };

            // A simple component for the Wall of Fame section
            const WallOfFame = () => {
                // You would fetch or define wall of fame data here
                return (
                    <div className="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600">
                        <h3 className="text-xl font-bold mb-4 text-white">Wall of Fame</h3>
                        <ul className="list-disc list-inside space-y-2 text-gray-300">
                            <li>Top Vendor of the Month: <span className="font-semibold text-cyan-400">Kariakoo Sports Gear</span></li>
                            <li>Most Sold Product: <span className="font-semibold text-cyan-400">Official Simba SC Jersey</span></li>
                            <li>Highest Rated Vendor: <span className="font-semibold text-cyan-400">Dar Tech Solutions</span></li>
                            <li>Community Contributor: <span className="font-semibold text-cyan-400">Fitness Hub TZ</span></li>
                        </ul>
                        <p className="text-gray-400 text-sm mt-4">
                            This section highlights top-performing vendors and products based on sales, ratings, and community engagement.
                        </p>
                    </div>
                );
            };

            return (
                <div className="container mx-auto p-4">
                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 border border-gray-700">
                        <img src="https://placehold.co/150x150/4b5563/ffffff?text=Vendor+Avatar" alt="Vendor Profile" className="w-32 h-32 rounded-full border-4 border-blue-600 object-cover" />
                        <div className="text-center md:text-left">
                            <h1 className="text-3xl font-bold text-white">{userProfile ? userProfile.email : 'Vendor Name'}</h1>
                            <p className="text-gray-400">Role: <span className="font-semibold text-cyan-400">{userProfile?.role || 'customer'}</span></p>
                            <p className="text-gray-400">Member Since: {userProfile?.createdAt ? new Date(userProfile.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            <button onClick={onLogout} className="mt-4 px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 font-semibold">
                                Logout
                            </button>
                        </div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="flex justify-center md:justify-start space-x-4 mb-6">
                        <button
                            onClick={() => setActiveTab('profile')}
                            className={`px-6 py-3 font-semibold rounded-lg transition-colors duration-200 ${activeTab === 'profile' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                        >
                            Profile
                        </button>
                        <button
                            onClick={() => setActiveTab('uploads')}
                            className={`px-6 py-3 font-semibold rounded-lg transition-colors duration-200 ${activeTab === 'uploads' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                        >
                            Uploads
                        </button>
                        <button
                            onClick={() => setActiveTab('fame')}
                            className={`px-6 py-3 font-semibold rounded-lg transition-colors duration-200 ${activeTab === 'fame' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                        >
                            Wall of Fame
                        </button>
                    </div>

                    {/* Content based on active tab */}
                    {activeTab === 'profile' && (
                        <div className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-white">Vendor Information</h2>
                            <p className="text-gray-300 mb-2"><strong>Business Name:</strong> {userProfile?.email ? userProfile.email.split('@')[0].replace('.', ' ').toUpperCase() : 'Your Business Name'}</p>
                            <p className="text-gray-300 mb-2"><strong>Contact Email:</strong> {userProfile ? userProfile.email : 'vendor@example.com'}</p>
                            <p className="text-gray-300 mb-2"><strong>Location:</strong> Dar es Salaam, Tanzania</p>
                            <p className="text-gray-300"><strong>Description:</strong> We are a trusted vendor specializing in high-quality sports equipment for Tanzania and East Africa. Our mission is to provide the best products and service to our customers.</p>
                            <p className="text-gray-400 text-sm mt-4">
                                This section would allow vendors to edit their business details, contact information, and business description.
                            </p>
                        </div>
                    )}

                    {activeTab === 'uploads' && (
                        <div className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-white">Your Uploads (Products)</h2>
                            <VendorProducts />
                            <p className="text-gray-400 text-sm mt-4">
                                This section would display all products listed by this vendor, with options to add new products, edit existing ones, or manage inventory.
                            </p>
                        </div>
                    )}

                    {activeTab === 'fame' && (
                        <div className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                            <WallOfFame />
                            <p className="text-gray-400 text-sm mt-4">
                                This section showcases achievements, top sales, and positive customer feedback for the vendor.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        /**
         * Section for displaying products in a shop.
         * Now receives cart and watchlist handlers and data from App.
         */
        const ShopSection = ({ customerLocation, setCustomerLocation, allLocations, userId, userPreferences, handleSavePreferences, handleLoadPreferences, activeCategory, setActiveCategory, selectedSportCompetition, setSelectedSportCompetition, cartItems, handleAddToCart, watchlistItems, handleAddToWatchlist }) => {
          const { db, isAuthReady } = useContext(AuthContext);

          // Products state, now fetched from Firestore
          const [products, setProducts] = useState([]);
          const [priceRange, setPriceRange] = useState([0, 200000]); // Adjusted for TZS
          const [selectedLocation, setSelectedLocation] = useState('All');
          const [selectedJerseyType, setSelectedJerseyType] = useState('All');
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedVendor, setSelectedVendor] = useState('All');
          // Removed showVendorModal from here as it's managed in App now

          // --- Pagination States ---
          const [currentPage, setCurrentPage] = useState(1);
          const productsPerPage = 10; // Display 10 products per page

          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

          // Effect to load products from Firestore
          useEffect(() => {
              if (db) {
                  const productsCollectionRef = firebase.collection(db, `artifacts/${appId}/public/data/products`);
                  const unsubscribe = firebase.onSnapshot(productsCollectionRef, (snapshot) => {
                      const fetchedProducts = snapshot.docs.map(doc => ({
                          id: doc.id,
                          ...doc.data()
                      }));
                      setProducts(fetchedProducts);
                  }, (error) => {
                      console.error("Error fetching products:", error);
                  });
                  return () => unsubscribe();
              }
          }, [db, appId]);


          // Dynamically generate categories based on current products
          const categories = ['All Products', ...new Set(products.map(p => p.category))].map(cat => ({
            name: cat,
            count: cat === 'All Products' ? products.length : products.filter(p => p.category === cat).length
          }));

          // Get unique vendors for the filter list from current products
          const uniqueVendors = [...new Set(products.map(p => p.vendor))].sort();

          // Function to handle new vendor registration and product listing (saves to Firestore)
          // This function is now passed down from App, so it's not defined here anymore.
          // const handleRegisterAndList = async (newProduct) => { ... };

          // Filter products based on active category and new filters
          const filteredProducts = products.filter(p => {
            let matchesCategory = activeCategory === 'All Products' || p.category === activeCategory;
            let matchesSportCompetition = selectedSportCompetition === 'All' || p.sportCompetition === selectedSportCompetition;
            let matchesPriceRange = p.price >= priceRange[0] && p.price <= priceRange[1];
            let matchesLocation = selectedLocation === 'All' || p.location === selectedLocation;
            // Only apply jersey type filter if the product is actually a Jersey
            let matchesJerseyType = selectedJerseyType === 'All' || p.category !== 'Jerseys' || p.jerseyType === selectedJerseyType;
            let matchesSearchTerm = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase()));
            let matchesVendor = selectedVendor === 'All' || p.vendor === selectedVendor;

            return matchesCategory && matchesSportCompetition && matchesPriceRange && matchesLocation && matchesJerseyType && matchesSearchTerm && matchesVendor;
          });

          // --- Pagination Logic ---
          const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
          const startIndex = (currentPage - 1) * productsPerPage;
          const endIndex = startIndex + productsPerPage;
          const productsToDisplay = filteredProducts.slice(startIndex, endIndex);

          const handleNextPage = () => {
              if (currentPage < totalPages) {
                  setCurrentPage(prevPage => prevPage + 1);
              }
          };

          const handlePreviousPage = () => {
              if (currentPage > 1) {
                  setCurrentPage(prevPage => prevPage - 1);
              }
          };

          // Reset page to 1 whenever filters change
          useEffect(() => {
              setCurrentPage(1);
          }, [activeCategory, selectedSportCompetition, priceRange, selectedLocation, selectedJerseyType, searchTerm, selectedVendor]);


          return (
            <React.Fragment>
                <div className="p-4 md:p-8">
                  <div className="max-w-7xl mx-auto">
                    {/* Search Bar */}
                    <div className="mb-8">
                        <div className="relative">
                            <input
                                type="text"
                                placeholder="Search for products..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full p-3 pl-10 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                aria-label="Search products"
                            />
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <div className="md:flex md:space-x-8">
                      <aside className="md:w-1/4 lg:w-1/5 mb-8 md:mb-0">
                        <div className="bg-gray-800 rounded-xl p-4 border border-gray-700">
                          <h3 className="text-lg font-bold mb-4 text-white">Categories</h3>
                          <div className="space-y-2">
                            {categories.map(cat => (
                              <button key={cat.name} onClick={() => setActiveCategory(cat.name)} className={`w-full flex justify-between items-center p-3 rounded-lg text-left transition-colors duration-200 ${activeCategory === cat.name ? 'bg-cyan-500 text-white font-semibold' : 'text-gray-300 hover:bg-gray-700'}`} aria-current={activeCategory === cat.name ? 'page' : undefined} aria-label={`Show ${cat.name} products (${cat.count})`}>
                                <span>{cat.name}</span>
                                <span className={`px-2 py-0.5 text-xs rounded-full ${activeCategory === cat.name ? 'bg-cyan-300 text-cyan-800' : 'bg-gray-600 text-gray-200'}`}>{cat.count}</span>
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Filters Section */}
                        <div className="bg-gray-800 rounded-xl p-4 border border-gray-700 mt-6">
                            <h3 className="text-lg font-bold mb-4 text-white">Filters</h3>

                            {/* Sport Competition Filter */}
                            <div className="mb-4">
                                <label htmlFor="sport-competition-filter" className="block text-gray-300 text-sm font-medium mb-2">Sport Competition</label>
                                <select
                                    id="sport-competition-filter"
                                    value={selectedSportCompetition}
                                    onChange={(e) => setSelectedSportCompetition(e.target.value)}
                                    className="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                >
                                    <option value="All">All Competitions</option>
                                    {/* Dynamically get sport competitions from products */}
                                    {[...new Set(products.map(p => p.sportCompetition))].filter(Boolean).sort().map(comp => <option key={comp} value={comp}>{comp}</option>)}
                                </select>
                            </div>

                            {/* Price Range Filter */}
                            <div className="mb-4">
                                <label htmlFor="price-range-min" className="block text-gray-300 text-sm font-medium mb-2">Price Range</label>
                                <div className="flex items-center space-x-2">
                                    <input
                                        type="number"
                                        id="price-range-min"
                                        value={priceRange[0]}
                                        onChange={(e) => setPriceRange([parseInt(e.target.value) || 0, priceRange[1]])}
                                        className="w-1/2 p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        placeholder="Min"
                                    />
                                    <span>-</span>
                                    <input
                                        type="number"
                                        id="price-range-max"
                                        value={priceRange[1]}
                                        onChange={(e) => setPriceRange([priceRange[0], parseInt(e.target.value) || 0])}
                                        className="w-1/2 p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        placeholder="Max"
                                    />
                                </div>
                            </div>

                            {/* Location Filter */}
                            <div className="mb-4">
                                <label htmlFor="location-filter" className="block text-gray-300 text-sm font-medium mb-2">Location</label>
                                <select
                                    id="location-filter"
                                    value={selectedLocation}
                                    onChange={(e) => setSelectedLocation(e.target.value)}
                                    className="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                >
                                    <option value="All">All Locations</option>
                                    {allLocations.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                                </select>
                            </div>

                            {/* Type of Jersey Filter (Conditional) */}
                            {activeCategory === 'Jerseys' && (
                                <div className="mb-4">
                                    <label htmlFor="jersey-type-filter" className="block text-gray-300 text-sm font-medium mb-2">Type of Jersey</label>
                                    <select
                                        id="jersey-type-filter"
                                        value={selectedJerseyType}
                                        onChange={(e) => setSelectedJerseyType(e.target.value)}
                                        className="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    >
                                        <option value="All">All Types</option>
                                        {/* Dynamically get jersey types from products */}
                                        {[...new Set(products.filter(p => p.category === 'Jerseys').map(p => p.jerseyType))].filter(Boolean).sort().map(type => <option key={type} value={type}>{type}</option>)}
                                    </select>
                                </div>
                            )}
                        </div>

                        {/* Vendor List Filter */}
                        <VendorList vendors={uniqueVendors} selectedVendor={selectedVendor} onSelectVendor={setSelectedVendor} />
                      </aside>
                      <main className="md:w-3/4 lg:w-4/5">
                        {productsToDisplay.length === 0 ? (
                            <p className="text-gray-400 text-center text-lg mt-8">No products found matching your criteria. Try adjusting your filters!</p>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                                {productsToDisplay.map(product => (<ProductCard key={product.id} product={product} onAddToCart={handleAddToCart} onAddToWatchlist={handleAddToWatchlist} />))}
                            </div>
                        )}
                        
                        {/* Pagination Controls */}
                        {filteredProducts.length > productsPerPage && (
                            <div className="flex justify-center items-center space-x-4 mt-8">
                                <button
                                    onClick={handlePreviousPage}
                                    disabled={currentPage === 1}
                                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${currentPage === 1 ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-cyan-600 text-white hover:bg-cyan-700'}`}
                                >
                                    Previous
                                </button>
                                <span className="text-lg font-semibold text-white">
                                    Page {currentPage} of {totalPages}
                                </span>
                                <button
                                    onClick={handleNextPage}
                                    disabled={currentPage === totalPages}
                                    className={`px-6 py-3 rounded-lg font-semibold transition-colors duration-200 ${currentPage === totalPages ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-cyan-600 text-white hover:bg-cyan-700'}`}
                                >
                                    Next
                                    </button>
                            </div>
                        )}
                      </main>
                    </div>
                  </div>
                </div> {/* Closing tag for the div with class "p-4 md:p-8" */}
                {/* Modals are rendered in App component */}
            </React.Fragment>
          );
        };

        // Root App component to provide AuthContext and manage pages
        const App = () => {
            const { db, auth, userId, userEmail, isAuthReady, isVendor, userProfile, signOutUser } = useContext(AuthContext); // Destructure new values
            const [activePage, setActivePage] = useState('shop'); // State to control which main page is active

            // Lifted states for shop filters
            const [activeCategory, setActiveCategory] = useState('All Products');
            const [selectedSportCompetition, setSelectedSportCompetition] = useState('All');

            // State to hold user preferences fetched from Firestore
            const [userPreferences, setUserPreferences] = useState({
                activeCategory: 'All Products',
                selectedSportCompetition: 'All',
                customerLocation: 'Dar es Salaam', // Default customer location
                userRole: 'customer' // Default user role in preferences
            });

            // States for all modals
            const [showVendorModal, setShowVendorModal] = useState(false);
            const [showPreferencesModal, setShowPreferencesModal] = useState(false);
            const [showCheckoutModal, setShowCheckoutModal] = useState(false);

            // Lifted states for cart and watchlist
            const [cartItems, setCartItems] = useState([]);
            const [watchlistItems, setWatchlistItems] = useState([]);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Effect to load user preferences from Firestore
            useEffect(() => {
                if (isAuthReady && db && userId) {
                    const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/preferences/shopPreferences`);
                    const unsubscribe = firebase.onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setUserPreferences(data);
                            // Update filter states in App based on loaded preferences
                            setActiveCategory(data.activeCategory || 'All Products');
                            setSelectedSportCompetition(data.selectedSportCompetition || 'All');
                            console.log("Loaded preferences:", data);
                        } else {
                            console.log("No preferences found for this user.");
                            setUserPreferences({ activeCategory: 'All Products', selectedSportCompetition: 'All', customerLocation: 'Dar es Salaam', userRole: 'customer' });
                            setActiveCategory('All Products');
                            setSelectedSportCompetition('All');
                        }
                    }, (error) => {
                        console.error("Error fetching preferences:", error);
                    });

                    return () => unsubscribe(); // Clean up listener
                }
            }, [isAuthReady, db, userId, appId]); // Re-run when auth state or db/userId changes

            // Effect to load cart items from Firestore
            useEffect(() => {
                if (db && userId) {
                    const cartCollectionRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/cartItems`);
                    const unsubscribe = firebase.onSnapshot(cartCollectionRef, (snapshot) => {
                        const fetchedCartItems = snapshot.docs.map(doc => ({
                            id: doc.id, // Firestore document ID
                            ...doc.data()
                        }));
                        setCartItems(fetchedCartItems);
                    }, (error) => {
                        console.error("Error fetching cart items:", error);
                    });
                    return () => unsubscribe();
                } else {
                    setCartItems([]); // Clear cart if not authenticated
                }
            }, [db, userId, appId]);

            // Effect to load watchlist items from Firestore
            useEffect(() => {
                if (db && userId) {
                    const watchlistCollectionRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/watchlistItems`);
                    const unsubscribe = firebase.onSnapshot(watchlistCollectionRef, (snapshot) => {
                        const fetchedWatchlistItems = snapshot.docs.map(doc => ({
                            id: doc.id, // Firestore document ID
                            ...doc.data()
                        }));
                        setWatchlistItems(fetchedWatchlistItems);
                    }, (error) => {
                        console.error("Error fetching watchlist items:", error);
                    });
                    return () => unsubscribe();
                } else {
                    setWatchlistItems([]); // Clear watchlist if not authenticated
                }
            }, [db, userId, appId]);

            // Function to save current filter settings and customer location as preferences
            const handleSavePreferences = async () => {
                if (db && userId) {
                    const preferencesToSave = {
                        activeCategory: activeCategory, // Use the lifted state
                        selectedSportCompetition: selectedSportCompetition, // Use the lifted state
                        customerLocation: userPreferences.customerLocation,
                        userRole: userProfile?.role || 'customer' // Save the current user role from userProfile
                    };
                    try {
                        const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/preferences/shopPreferences`);
                        await firebase.setDoc(docRef, preferencesToSave, { merge: true });
                        console.log("Preferences saved successfully!");
                        setUserPreferences(preferencesToSave); // Update local state
                    } catch (error) {
                        console.error("Error saving preferences:", error);
                    }
                } else {
                    console.warn("Cannot save preferences: User not authenticated or Firebase not ready.");
                }
            };

            // Function to load saved preferences and apply them to filters
            const handleLoadPreferences = () => {
                // This will trigger the useEffect for preferences, which will then update activeCategory and selectedSportCompetition
                setActivePage('shop'); // Navigate back to shop if loading preferences
                console.log("Applied loaded preferences to filters.");
            };

            // Function to update customer location from preferences modal
            const handleSetCustomerLocation = (location) => {
                setUserPreferences(prev => ({ ...prev, customerLocation: location }));
            };

            // Function to add item to cart (Firestore)
            const handleAddToCart = async (product) => {
                if (!db || !userId) {
                    // Using console.error instead of alert for better UX
                    console.error("Please sign in to add items to your cart.");
                    return;
                }
                try {
                    const cartCollectionRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/cartItems`);
                    // Check if product already exists in cart to prevent duplicates
                    const existingCartItemQuery = firebase.query(cartCollectionRef, firebase.where("productId", "==", product.id));
                    const querySnapshot = await firebase.getDocs(existingCartItemQuery);

                    if (querySnapshot.empty) {
                        await firebase.addDoc(cartCollectionRef, {
                            productId: product.id, // Store original product ID
                            name: product.name,
                            price: product.price,
                            imageUrl: product.imageUrl,
                            location: product.location, // Include vendor location for shipping calculation
                            quantity: 1, // Assume quantity 1 for now
                            addedAt: firebase.serverTimestamp(), // Use server timestamp
                        });
                        console.log(`${product.name} added to cart!`);
                    } else {
                        // If item exists, you could increment quantity here if desired
                        console.log(`${product.name} is already in your cart.`);
                    }
                } catch (error) {
                    console.error("Error adding to cart:", error);
                    // Using console.error instead of alert for better UX
                    console.error("Failed to add item to cart. Please try again.");
                }
            };

            // Function to remove item from cart (Firestore)
            const handleRemoveFromCart = async (cartItemId) => {
                if (!db || !userId) {
                    // Using console.error instead of alert for better UX
                    console.error("You must be signed in to modify your cart.");
                    return;
                }
                try {
                    await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/cartItems`, cartItemId));
                    console.log(`Item removed from cart!`);
                } catch (error) {
                    console.error("Error removing from cart:", error);
                    // Using console.error instead of alert for better UX
                    console.error("Failed to remove item from cart. Please try again.");
                }
            };

            // Function to add item to watchlist (Firestore)
            const handleAddToWatchlist = async (product) => {
                if (!db || !userId) {
                    // Using console.error instead of alert for better UX
                    console.error("Please sign in to add items to your watchlist.");
                    return;
                }
                try {
                    const watchlistCollectionRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/watchlistItems`);
                    // Check if product already exists in watchlist to prevent duplicates
                    const existingWatchlistItemQuery = firebase.query(watchlistCollectionRef, firebase.where("productId", "==", product.id));
                    const querySnapshot = await firebase.getDocs(existingWatchlistItemQuery);

                    if (querySnapshot.empty) {
                        await firebase.addDoc(watchlistCollectionRef, {
                            productId: product.id, // Store original product ID
                            name: product.name,
                            price: product.price,
                            imageUrl: product.imageUrl,
                            addedAt: firebase.serverTimestamp(), // Use server timestamp
                        });
                        console.log(`${product.name} added to watchlist!`);
                    } else {
                        console.log(`${product.name} is already in your watchlist.`);
                    }
                } catch (error) {
                    console.error("Error adding to watchlist:", error);
                    // Using console.error instead of alert for better UX
                    console.error("Failed to add item to watchlist. Please try again.");
                }
            };

            // Function to remove item from watchlist (Firestore)
            const handleRemoveFromWatchlist = async (watchlistItemId) => {
                if (!db || !userId) {
                    // Using console.error instead of alert for better UX
                    console.error("You must be signed in to modify your watchlist.");
                    return;
                }
                try {
                    await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/watchlistItems`, watchlistItemId));
                    console.log(`Item removed from watchlist!`);
                } catch (error) {
                    console.error("Error removing from watchlist:", error);
                    // Using console.error instead of alert for better UX
                    console.error("Failed to remove item from watchlist. Please try again.");
                }
            };

            // Function to update user role (e.g., from customer to vendor/admin)
            const handleSetUserRole = async (newRole) => {
                if (db && userId && userProfile) {
                    try {
                        const userDocRef = firebase.doc(db, `artifacts/${appId}/users/${userId}`);
                        await firebase.setDoc(userDocRef, { role: newRole }, { merge: true });
                        // The AuthProvider's onAuthStateChanged listener will pick up this change
                        // and update isVendor and userProfile state, so no direct state update here.
                        console.log(`User role updated to: ${newRole}`);
                    } catch (error) {
                        console.error("Error updating user role:", error);
                    }
                }
            };


            const renderPage = () => {
                // If user is a vendor, always show VendorProfile
                if (isVendor) {
                    return <VendorProfile userProfile={userProfile} onLogout={signOutUser} />;
                }

                // Otherwise, render pages based on activePage state
                switch (activePage) {
                    case 'shop':
                        return (
                            <ShopSection
                                customerLocation={userPreferences.customerLocation}
                                setCustomerLocation={handleSetCustomerLocation}
                                allLocations={allLocations}
                                userId={userId}
                                userPreferences={userPreferences}
                                handleSavePreferences={handleSavePreferences}
                                handleLoadPreferences={handleLoadPreferences}
                                activeCategory={activeCategory} // Pass lifted state
                                setActiveCategory={setActiveCategory} // Pass setter
                                selectedSportCompetition={selectedSportCompetition} // Pass lifted state
                                setSelectedSportCompetition={setSelectedSportCompetition} // Pass setter
                                cartItems={cartItems} // Pass cart items
                                handleAddToCart={handleAddToCart} // Pass add to cart handler
                                watchlistItems={watchlistItems} // Pass watchlist items
                                handleAddToWatchlist={handleAddToWatchlist} // Pass add to watchlist handler
                            />
                        );
                    case 'dailyDeals':
                        return <DailyDealsPage />;
                    case 'brandOutlet':
                        return <BrandOutletPage />;
                    case 'giftCards':
                        // GiftCardsPage now uses the main handleAddToCart
                        return <GiftCardsPage onAddGiftCardToCart={handleAddToCart} />;
                    case 'helpContact':
                        return <HelpContactPage />;
                    case 'watchlist':
                        // WatchlistPage now receives its items and removal function directly
                        return <WatchlistPage watchlistItems={watchlistItems} onRemoveFromWatchlist={handleRemoveFromWatchlist} />;
                    case 'notifications':
                        return <NotificationsPage />;
                    case 'liveUpdates':
                        return <LiveUpdatesSection />;
                    case 'news':
                        return <NewsSection />;
                    case 'adminDashboard':
                        // Only allow access if user is an admin
                        return userProfile?.role === 'admin' ? <AdminDashboardPage /> : <p className="text-red-500 text-center text-lg mt-8">Access Denied: You are not authorized to view the Admin Dashboard.</p>;
                    default:
                        return (
                            <ShopSection
                                customerLocation={userPreferences.customerLocation}
                                setCustomerLocation={handleSetCustomerLocation}
                                allLocations={allLocations}
                                userId={userId}
                                userPreferences={userPreferences}
                                handleSavePreferences={handleSavePreferences}
                                handleLoadPreferences={handleLoadPreferences}
                                activeCategory={activeCategory} // Pass lifted state
                                setActiveCategory={setActiveCategory} // Pass setter
                                selectedSportCompetition={selectedSportCompetition} // Pass lifted state
                                setSelectedSportCompetition={setSelectedSportCompetition} // Pass setter
                                cartItems={cartItems} // Pass cart items
                                handleAddToCart={handleAddToCart} // Pass add to cart handler
                                watchlistItems={watchlistItems} // Pass watchlist items
                                handleAddToWatchlist={handleAddToWatchlist} // Pass add to watchlist handler
                            />
                        );
                }
            };

            return (
                <React.Fragment>
                    <div className="p-4 md:p-8">
                        <div className="max-w-7xl mx-auto">
                            {/* Top Utility Navigation */}
                            <div className="flex justify-between items-center text-xs text-gray-400 mb-4 border-b border-gray-700 pb-2">
                                <div className="flex space-x-4">
                                    <button onClick={() => setShowPreferencesModal(true)} className="hover:text-white transition-colors">Sign in or register</button>
                                    <button onClick={() => setActivePage('dailyDeals')} className="hover:text-white transition-colors">Daily Deals</button>
                                    <button onClick={() => setActivePage('brandOutlet')} className="hover:text-white transition-colors">Brand Outlet</button>
                                    <button onClick={() => setActivePage('giftCards')} className="hover:text-white transition-colors">Gift Cards</button>
                                    <button onClick={() => setActivePage('helpContact')} className="hover:text-white transition-colors">Help & Contact</button>
                                </div>
                                <div className="flex space-x-4">
                                    <button onClick={() => setShowPreferencesModal(true)} className="hidden sm:block hover:text-white transition-colors">Ship to</button>
                                    {/* Only show "Sell" button if not a vendor, or if vendor wants to list more products (can be handled within VendorProfile) */}
                                    {!isVendor && (
                                        <button onClick={() => setShowVendorModal(true)} className="hover:text-white transition-colors">Sell</button>
                                    )}
                                    <button onClick={() => setActivePage('watchlist')} className="hover:text-white transition-colors">Watchlist</button>
                                    <button onClick={() => setShowPreferencesModal(true)} className="hover:text-white transition-colors">My Kariakoo Online Mall</button>
                                    <button onClick={() => setActivePage('notifications')} className="hover:text-white transition-colors">Notifications</button>
                                    <button onClick={() => setActivePage('liveUpdates')} className="hover:text-white transition-colors">Live Updates</button>
                                    <button onClick={() => setActivePage('news')} className="hover:text-white transition-colors">News & Updates</button>
                                    {userProfile?.role === 'admin' && ( // Only show Admin Dashboard if user has 'admin' role
                                        <button onClick={() => setActivePage('adminDashboard')} className="hover:text-red-400 transition-colors font-bold">Admin Dashboard</button>
                                    )}
                                </div>
                            </div>

                            {/* Main Header with Shop Title and Cart */}
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                                    <svg className="w-8 h-8 text-cyan-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.5 14 6.354 14H17a1 1 0 000-2h-1.539l-.821-2.82a1 1 0 00-.01-.042l-1.358-5.43L8.12 3H3zM10 18a1 1 0 100-2 1 1 0 000 2zm-2 0a1 1 0 100-2 1 1 0 000 2zm5-5a1 1 0 100-2 1 1 0 000 2zm2 0a1 1 0 100-2 1 1 0 000 2z"></path></svg>
                                    <button onClick={() => setActivePage('shop')} className="hover:text-cyan-400 transition-colors">Kariakoo Online Mall</button>
                                </h2>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => setShowVendorModal(true)}
                                        className="flex items-center space-x-2 px-4 py-2 bg-emerald-600 rounded-full text-white hover:bg-emerald-700 transition-colors duration-200 text-sm font-semibold"
                                        aria-label="Become a Vendor"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                                        <span>Become a Vendor</span>
                                    </button>
                                    <button
                                        onClick={() => setShowPreferencesModal(true)}
                                        className="flex items-center space-x-2 px-4 py-2 bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors duration-200 text-sm font-semibold"
                                        aria-label="My Account and Preferences"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                                        <span>My Account</span>
                                    </button>
                                    {/* Cart button now reflects real cart items from Firestore */}
                                    <button
                                        onClick={() => setShowCheckoutModal(true)}
                                        className="flex items-center space-x-2 px-4 py-2 bg-gray-700 rounded-full text-gray-300 hover:bg-gray-600 transition-colors duration-200"
                                        aria-label="View shopping cart"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.5 14 6.354 14H17a1 1 0 000-2h-1.539l-.821-2.82a1 1 0 00-.01-.042l-1.358-5.43L8.12 3H3zM10 18a1 1 0 100-2 1 1 0 000 2zm-2 0a1 1 0 100-2 1 1 0 000 2zm5-5a1 1 0 100-2 1 1 0 000 2zm2 0a1 1 0 100-2 1 1 0 000 2z"></path></svg>
                                        <span>Cart ({cartItems.length})</span>
                                    </button>
                                </div>
                            </div>

                            {/* Big Advert Banner - Always visible regardless of activePage */}
                            <div className="relative bg-gradient-to-r from-blue-600 to-cyan-500 rounded-xl p-8 mb-8 text-center shadow-lg overflow-hidden">
                                <div className="absolute inset-0 opacity-20" style={{ backgroundImage: 'url(https://placehold.co/1200x300/ffffff/000000?text=Shop+Now)', backgroundSize: 'cover', backgroundPosition: 'center' }}></div>
                                <div className="relative z-10">
                                    <h3 className="text-4xl md:text-5xl font-extrabold mb-3 text-white">
                                        Your One-Stop Online Shop!
                                    </h3>
                                    <p className="text-lg md:text-xl text-white text-opacity-90 mb-6">
                                        Discover amazing deals on sports gear, fashion, beauty, and more.
                                    </p>
                                    <button className="bg-white text-blue-700 font-bold py-3 px-8 rounded-full shadow-md hover:bg-gray-200 transition-colors duration-300 transform hover:scale-105" aria-label="Shop Now for exclusive deals">
                                        Shop Now
                                    </button>
                                </div>
                            </div>

                            {/* Render active page content */}
                            {renderPage()}

                        </div>
                    </div>

                    {/* Modals (always rendered but conditionally visible) */}
                    <VendorRegistrationModal
                        isOpen={showVendorModal}
                        onClose={() => setShowVendorModal(false)}
                        onRegisterAndList={async (newProduct) => {
                            if (!db || !userId) {
                                console.error("Please sign in to register as a vendor and list products.");
                                return;
                            }
                            try {
                                // Add product to the public products collection
                                await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/products`), newProduct);
                                console.log("New product added to Firestore:", newProduct);

                                // Also update the user's role to 'vendor' if they are registering as one
                                const userDocRef = firebase.doc(db, `artifacts/${appId}/users/${userId}`);
                                await firebase.setDoc(userDocRef, { role: 'vendor' }, { merge: true });

                                console.log("Product listed and user role updated to vendor successfully!");
                                setShowVendorModal(false); // Close modal on success
                            } catch (error) {
                                console.error("Error adding new product or updating role:", error);
                                console.error("Failed to list product or update role. Please try again.");
                            }
                        }}
                    />
                    <UserPreferencesModal
                        isOpen={showPreferencesModal}
                        onClose={() => setShowPreferencesModal(false)}
                        preferences={userPreferences}
                        onSavePreferences={handleSavePreferences}
                        onLoadPreferences={handleLoadPreferences}
                        userId={userId}
                        userEmail={userEmail} // Pass user email
                        customerLocation={userPreferences.customerLocation}
                        setCustomerLocation={handleSetCustomerLocation}
                        allLocations={allLocations}
                        userRole={userProfile?.role || 'customer'} // Pass actual user role from profile
                        setUserRole={handleSetUserRole} // Pass the function to update user role
                        auth={auth} // Pass the auth instance
                    />
                    <CheckoutModal
                        isOpen={showCheckoutModal}
                        onClose={() => setShowCheckoutModal(false)}
                        cartItems={cartItems} // Pass cart items from App's state
                        customerLocation={userPreferences.customerLocation}
                    />

                    {/* Footer Section */}
                    <footer className="bg-gray-900 text-gray-400 text-center py-6 mt-12 border-t border-gray-700">
                        <p className="text-sm mb-2">Copyright &copy; 2025 developed by David Mbazza</p>
                        <p className="text-sm">Dedicated to Tanzania and East Africa states sports.</p>
                    </footer>
                </React.Fragment>
            );
        };

        // Component to display cart count (now directly uses AuthContext and Firestore)
        const CartCount = () => {
            const { db, userId } = useContext(AuthContext);
            const [count, setCount] = useState(0);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (db && userId) {
                    const cartCollectionRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/cartItems`);
                    const unsubscribe = firebase.onSnapshot(cartCollectionRef, (snapshot) => {
                        setCount(snapshot.size);
                    }, (error) => {
                        console.error("Error fetching cart count:", error);
                    });
                    return () => unsubscribe();
                } else {
                    setCount(0);
                }
            }, [db, userId, appId]);

            return count;
        };


        // New Root component to wrap App with AuthProvider
        const Root = () => (
            <AuthProvider>
                <App />
            </AuthProvider>
        );

        // Render the Root component into the 'root' div
        ReactDOM.render(<Root />, document.getElementById('root'));
    </script>
</body>
</html>
